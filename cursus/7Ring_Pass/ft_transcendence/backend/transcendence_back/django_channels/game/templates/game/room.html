<!DOCTYPE html>
<html>
<head>
    <title>Pong Game</title>
    <style>
        canvas {
            background: black;
            display: block;
            margin: auto;
        }
        .scoreboard {
            position: absolute;
            top: 25px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 300px;
            font-family: Arial, sans-serif;
        }
        .score-right {
            position: absolute;
            left: 200px;
        }
        .score-left {
            position: absolute;
            right: 200px;
        }
        .game-end-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-size: 30px;
            font-family: Arial, sans-serif;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            width: 80%; 
            max-width: 600px;
        }
        .game-start-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-size: 30px;
            font-family: Arial, sans-serif;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            width: 80%; 
            max-width: 600px;
        }
    </style>
</head>
<body>      
    <canvas id="pongCanvas" width="800" height="400"></canvas>
    <div class="scoreboard score-left" id="scoreLeft">0</div>
    <div class="scoreboard score-right" id="scoreRight">0</div>
    <div class="game-end-message" id="gameEndMessage"></div>
    <div class="game-start-message" id="gameStartMessage"></div>
    {{ room_name|json_script:"room-name" }}

    <script>
        const pathArray = window.location.pathname.split('/');
        const roomName = pathArray[2];  
        const player_id = pathArray[3];
        
        const canvas = document.getElementById('pongCanvas');
        const context = canvas.getContext('2d');
        const paddleWidth = 10, paddleHeight = 100, ballSize = 10;
        
        const socket = new WebSocket('wss://' + window.location.host + '/ws/game/' + roomName + '/' + player_id + '/'); // Change 1 for user id
        
        let gameInProgress = true;

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'direct_message') {
                alert(data.message);  // Mostrar el mensaje directo al usuario
            } else if (data.type === 'game_end') {
                document.getElementById('gameEndMessage').innerHTML = data.message;
                gameInProgress = false;
            } else if (data.type === 'game_start') {
                const groupMessageDiv = document.getElementById('gameStartMessage');
               groupMessageDiv.innerHTML = data.message;
               groupMessageDiv.style.display = 'block';  // Show the group message
                setTimeout(() => {
                    groupMessageDiv.style.display = 'none';  // Hide the message after some time
                }, 4000);  // Adjust the duration as needed
                gameInProgress = true;
            } else {
                drawEverything(data);  // Manejar actualizaciones normales del juego
            }
        };

        socket.onclose = function(event) {
            console.error('Chat socket closed unexpectedly');
        };

        // Event listener para cualquier tecla presionada en el documento
        document.addEventListener('click', function(event) {
            if (!gameInProgress) {
                socket.send(JSON.stringify({ type: 'restart' }));
                document.getElementById('gameEndMessage').innerHTML = '';
                gameInProgress = true;
            }
        });

        document.addEventListener('keydown', (event) => {
            let message = null;
            if (gameInProgress) {
                switch (event.key) {
                    case 'w':
                        message = {'type': 'move', 'player': 1, 'direction': 'up'};
                        break;
                    case 's':
                        message = {'type': 'move', 'player': 1, 'direction': 'down'};
                        break;
                    case 'ArrowUp':
                        message = {'type': 'move', 'player': 2, 'direction': 'up'};
                        break;
                    case 'ArrowDown':
                        message = {'type': 'move', 'player': 2, 'direction': 'down'};
                        break;
                }
            }
            if (message) {
                socket.send(JSON.stringify(message));
            }
        });

        document.addEventListener('keyup', (event) => {
            let message = null;
            if (gameInProgress) {
                switch (event.key) {
                    case 'w':
                    case 's':
                        message = {'type': 'move', 'player': 1, 'direction': 'stop'};
                        break;
                    case 'ArrowUp':
                    case 'ArrowDown':
                        message = {'type': 'move', 'player': 2, 'direction': 'stop'};
                        break;
                }
            }
            if (message) {
                socket.send(JSON.stringify(message));
            }
        });

        function drawRect(x, y, width, height, color) {
            context.fillStyle = color;
            context.fillRect(x, y, width, height);
        }

        function drawCircle(x, y, radius, color) {
            context.fillStyle = color;
            context.beginPath();
            context.arc(x, y, radius, 0, Math.PI * 2, true);
            context.closePath();
            context.fill();
        }

        function drawNet() {
            for (let i = 0; i < canvas.height; i += 15) {
                drawRect(canvas.width / 2 - 1, i, 2, 10, 'white');
            }
        }

        function drawEverything(gameState) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            drawRect(0, 0, canvas.width, canvas.height, 'black');
            drawNet();
            drawRect(0, gameState.player1Y, paddleWidth, paddleHeight, 'white');
            drawRect(canvas.width - paddleWidth, gameState.player2Y, paddleWidth, paddleHeight, 'white');
            drawCircle(gameState.ballX, gameState.ballY, ballSize, 'white');
            document.getElementById('scoreLeft').innerText = gameState.scoreLeft;
            document.getElementById('scoreRight').innerText = gameState.scoreRight;
        }
    </script>
</body>
</html>