# -----------------------------------------------------------------------------
# --- Argo CD Deployment & Troubleshooting Command Reference (with Env Vars) ---
# -----------------------------------------------------------------------------

# Check if a K3d cluster exists
k3d cluster get "$CLUSTER_NAME"

# Delete a K3d cluster (useful for a clean start)
k3d cluster delete "$CLUSTER_NAME"

# Get kubeconfig for a K3d cluster
k3d kubeconfig get "$CLUSTER_NAME"


# --- Kubernetes CLI (kubectl) - General Cluster Interaction ---
# Check node status
kubectl get nodes -o wide

# Create a namespace (Argo CD and dev namespaces)
kubectl create namespace "$ARGOCD_NAMESPACE" || echo "Namespace $ARGOCD_NAMESPACE already exists"
kubectl create namespace dev || echo "Namespace dev already exists"

# Get all pods in the Argo CD namespace
kubectl get pods -n "$ARGOCD_NAMESPACE" -o wide

# Get logs from Argo CD server pod
kubectl logs -n "$ARGOCD_NAMESPACE" -l app.kubernetes.io/name=argocd-server -f --tail=200

# Get logs from Argo CD Redis pod
kubectl logs -n "$ARGOCD_NAMESPACE" -l app.kubernetes.io/name=argocd-redis --tail=50

# Get logs from Argo CD Application Controller pod
kubectl logs -n "$ARGOCD_NAMESPACE" -l app.kubernetes.io/name=argocd-application-controller --tail=100

# Get Argo CD Secret details in YAML format
kubectl get secret argocd-secret -n "$ARGOCD_NAMESPACE" -o yaml

# Get Argo CD ConfigMap (argocd-cm) details in YAML format
kubectl get configmap argocd-cm -n "$ARGOCD_NAMESPACE" -o yaml

# Get Argo CD RBAC ConfigMap (argocd-rbac-cm) details in YAML format
kubectl get configmap argocd-rbac-cm -n "$ARGOCD_NAMESPACE" -o yaml

# Describe a resource (e.g., argocd-server deployment for debugging)
kubectl describe deployment argocd-server -n "$ARGOCD_NAMESPACE"
kubectl describe deployment argocd-application-controller -n "$ARGOCD_NAMESPACE"
kubectl describe deployment argocd-redis -n "$ARGOCD_NAMESPACE"

# Wait for Argo CD server deployment to become available
kubectl wait --for=condition=available deployment/argocd-server -n "$ARGOCD_NAMESPACE" --timeout=300s

# Patch the argocd-secret to set/update password for $USER_LOGIN
# (PATCH_PASS and PATCH_TIME are the Base64 encoded hash and mtime)
JSON_PATCH_DATA_VAR=$(cat <<EOF
{
  "data": {
    "accounts.${USER_LOGIN}.password": "$PATCH_PASS",
    "accounts.${USER_LOGIN}.passwordMtime": "$PATCH_TIME"
  }
}
EOF
)
kubectl patch secret argocd-secret -n "$ARGOCD_NAMESPACE" --type merge -p "$JSON_PATCH_DATA_VAR"

# Delete Argo CD server pod (to force a restart and pick up patched secret)
kubectl delete pod -n "$ARGOCD_NAMESPACE" -l app.kubernetes.io/name=argocd-server --wait=false

# Get Kubernetes events in the Argo CD namespace
kubectl get events -n "$ARGOCD_NAMESPACE" --sort-by='.lastTimestamp'

# Get NetworkPolicies (should be none in your case based on previous checks)
kubectl get networkpolicy -n "$ARGOCD_NAMESPACE"
kubectl get networkpolicy --all-namespaces


# --- Helm Commands (Kubernetes Package Manager) ---

# Add the Argo CD Helm chart repository
helm repo add argo https://argoproj.github.io/argo-helm || echo "Repo argo already added or error"

# Update local Helm chart repository information
helm repo update

# List currently added Helm repositories
helm repo list

# --- Argo CD CLI (`argocd`) Commands ---
# (Run these as the 'vagrant' user or after setting up KUBECONFIG for the current user)

# Login to Argo CD server
argocd login "$IP:$NODEPORT_HTTP" --username "$USER_LOGIN" --password "$USER_PASS" --insecure

# Check RBAC permissions for $USER_LOGIN
argocd admin settings rbac can "$USER_LOGIN" get applications "development/$ARGOCD_APP_NAME" --namespace "$ARGOCD_NAMESPACE"
argocd admin settings rbac can "$USER_LOGIN" '*' applications '*/*' --namespace "$ARGOCD_NAMESPACE"
argocd admin settings rbac can "$USER_LOGIN" get projects development --namespace "$ARGOCD_NAMESPACE"

# List Argo CD applications
argocd app list

# Get details of the specific Argo CD application $ARGOCD_APP_NAME
argocd app get "$ARGOCD_APP_NAME" --output yaml


# --- Argo CD Specific CRDs (Managed by kubectl) ---

# Get Argo CD Application CRD instance for $ARGOCD_APP_NAME
kubectl get application "$ARGOCD_APP_NAME" -n "$ARGOCD_NAMESPACE" -o yaml

# Get Argo CD AppProject CRD instance for "development"
kubectl get appproject development -n "$ARGOCD_NAMESPACE" -o yaml
